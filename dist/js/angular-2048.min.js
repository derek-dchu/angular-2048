"use strict";var app=angular.module("2048App",["Game","Grid","Keyboard"]);app.run(["$templateCache",function(e){e.put("mainId.html",'<div id="content" ng-controller="GameController as gctrl"><div class="row"><div id="game-board" class="col-md-9"><div grid ng-model="gctrl.gameManager"></div> </div><div id="user-board" class="col-md-3"><div class="score"><p>Current Score: {{ gctrl.gameManager.currentScore }}</p></div><div class="best-score"><p>Best Score: {{ gctrl.gameManager.bestScore }}</p></div></div></div></div>'),e.put("gridId.html",'<div class="grid-container"><div class="grid-cell"ng-repeat="cell in ngModel.grid track by $index"></div></div><div class="tile-container"><div tile ng-model="tile" ng-repeat="tile in ngModel.tiles track by $id(tile.id || $index)"></div></div>'),e.put("tileId.html",'<div ng-if="ngModel" class="tile tile-{{ ngModel.value }} position-{{ ngModel.coordinate.x }}-{{ ngModel.coordinate.y }}"><div class="tile-inner">{{ ngModel.value }}</div></div>')}]),app.controller("GameController",["GameManager","KeyboardManager",function(e,i){this.gameManager=e,this.newGame=function(){i.init(),this.gameManager.newGame(),this.startGame()},this.startGame=function(){var e=this;i.on(function(i){e.gameManager.move(i)})},this.newGame()}]),angular.module("Game",["Grid","ngCookies"]).service("GameManager",["$q","GridManager","$cookieStore",function(e,i,t){this.grid=i.grid,this.tiles=i.tiles,this.winningValue=2048,this.reinit=function(){this.currentScore=0,this.bestScore=this.getBestScore(),this.win=!1,this.gameOver=!1},this.newGame=function(){i.generateEmptyGameBoard(),i.initGameBoard(),this.reinit()},this.move=function(t){var n=this,r=function(){if(n.gameOver)return!1;var e=i.coordinatesInDirection(t),r=!1;i.prepareTiles(),e.x.forEach(function(o){e.y.forEach(function(e){var a={x:o,y:e},s=i.getCellAt(a);if(s){var l=i.nextAvailableCellInDirection(s.coordinate,t),c=l.nextTile;if(c&&c.value===s.value&&!c.merged){var d=2*s.value,h=i.newTile(s.coordinate,d);h.merged=!0,i.removeTile(s),i.insertTile(h),i.moveTile(h,c.coordinate),n.updateScore(n.currentScore+d),d>=n.winningValue&&(this.win=!0),r=!0}else i.areSameCoordinates(a,l.nextCoordinate)||(i.moveTile(s,l.nextCoordinate),r=!0)}})}),r&&(i.randomlyInsertTile(),(n.win||!n.moveAvailable())&&(n.gameOver=!0))};return e.when(r())},this.updateScore=function(e){this.currentScore=e,this.currentScore>this.bestScore&&(this.bestScore=this.currentScore,t.put("bestScore",this.currentScore))},this.moveAvailable=function(){return i.isAnyCellAvailable()||i.isTileMatchesAvailable()},this.getBestScore=function(){return parseInt(t.get("bestScore"))||0}}]),angular.module("Grid",[]).factory("TileModel",function(){var e=16,i=function(i,t){this.coordinate=i,this.value=t||2,this.merged=!1,this.id=e++};return i.prototype.getPosition=function(){return this.coordinate},i.prototype.updateCoordinate=function(e){this.coordinate=e},i.prototype.reset=function(){this.merged=!1},i}).service("GridManager",["TileModel",function(e){this.grid=[],this.tiles=[],this.size=4,this.initTileNumber=2;var i={left:{x:-1,y:0},right:{x:1,y:0},up:{x:0,y:-1},down:{x:0,y:1}};this.newTile=function(i,t){return new e(i,t)},this.generateEmptyGameBoard=function(){for(var e=0;e<Math.pow(this.size,2);e++)this.grid[e]=null,this.tiles[e]=null},this.initGameBoard=function(){for(var e=0;e<this.initTileNumber;e++)this.randomlyInsertTile()},this.isTileMatchesAvailable=function(){for(var e=0;e<Math.pow(this.size,2);e++){var t=this._positionToCoordinate(e),n=this.tiles[e];if(n)for(var r in i){var o=i[r],a={x:t.x+o.x,y:t.y+o.y};if(this.isWithinGrid(a)&&this.getCellAt(a).value==n.value)return!0}}return!1},this.coordinatesInDirection=function(e){for(var t=i[e],n={x:[],y:[]},r=0;r<this.size;r++)n.x.push(r),n.y.push(r);return t.x>0&&(n.x=n.x.reverse()),t.y>0&&(n.y=n.y.reverse()),n},this.nextAvailableCellInDirection=function(e,t){var n,r=i[t];do n=e,e={x:n.x+r.x,y:n.y+r.y};while(this.isCellAvailable(e));return{nextCoordinate:n,nextTile:this.getCellAt(e)}},this.isCellAvailable=function(e){return this.isWithinGrid(e)&&!this.getCellAt(e)},this.availableCells=function(){var e=[],i=this;return this.forEachCell(function(t){i.isCellAvailable(t)&&e.push(t)}),e},this.isAnyCellAvailable=function(){return this.availableCells().length>0},this.randomAvailableCell=function(){var e=this.availableCells();return e.length>0?e[Math.floor(Math.random()*e.length)]:void 0},this.forEachCell=function(e){for(var i=0;i<Math.pow(this.size,2);i++){var t=this._positionToCoordinate(i);e(t,this.tiles[i])}},this.setCellAt=function(e,i){var t=this._coordinateToPosition(e);this.tiles[t]=i},this.getCellAt=function(e){var i=this._coordinateToPosition(e);return this.tiles[i]},this.prepareTiles=function(){this.forEachCell(function(e,i){i&&i.reset()})},this.insertTile=function(e){this.setCellAt(e.coordinate,e)},this.removeTile=function(e){var i=this._coordinateToPosition(e.coordinate);delete this.tiles[i]},this.randomlyInsertTile=function(){var e=this.randomAvailableCell(),i=this.newTile(e,2);this.setCellAt(i.coordinate,i)},this.moveTile=function(e,i){this.setCellAt(e.coordinate,null),this.setCellAt(i,e),e.updateCoordinate(i)},this._positionToCoordinate=function(e){return 0>e||e>=Math.pow(this.size,2)?null:{x:Math.trunc(e/this.size),y:e%this.size}},this._coordinateToPosition=function(e){return e.x*this.size+e.y},this.isWithinGrid=function(e){return e.x>=0&&e.x<this.size&&e.y>=0&&e.y<this.size},this.areSameCoordinates=function(e,i){return e.x===i.x?e.y===i.y:!1}}]),angular.module("Grid").directive("grid",function(){return{restrict:"A",require:"ngModel",scope:{ngModel:"="},templateUrl:"gridId.html"}}),angular.module("Grid").directive("tile",function(){return{restrict:"A",require:"ngModel",scope:{ngModel:"="},templateUrl:"tileId.html"}}),angular.module("Keyboard",[]).service("KeyboardManager",["$document",function(e){var i={37:"left",38:"up",39:"right",40:"down"};this.init=function(){var t=this;this.keyEventHandlers=[],e.bind("keydown",function(e){var n=i[e.which];n&&(e.preventDefault(),t._handleKeyEvent(n,e))})},this._handleKeyEvent=function(e,i){var t=this.keyEventHandlers;if(t)for(var n=0;n<t.length;n++){var r=t[n];r(e,i)}},this.on=function(e){this.keyEventHandlers.push(e)}}]);